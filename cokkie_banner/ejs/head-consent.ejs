<script>
  window.env = {
    GA_MEASUREMENT_ID: "<%= process.env.GA_MEASUREMENT_ID %>",
    CLARITY_ID: "<%= process.env.CLARITY_ID %>"
  };

  window.dataLayer = window.dataLayer || [];

  function gtag() {
    dataLayer.push(arguments);
  }

  gtag('consent', 'default', {
    analytics_storage: 'denied',
    ad_storage: 'denied',
    ad_user_data: 'denied',
    ad_personalization: 'denied',
    wait_for_update: 500
  });

  function loadGA() {
    if (window.__gaLoaded) return;
    window.__gaLoaded = true;

    var s = document.createElement('script');
    s.async = true;
    s.src = "https://www.googletagmanager.com/gtag/js?id=<%= process.env.GA_MEASUREMENT_ID %>";
    document.head.appendChild(s);

    s.onload = function() {
      gtag('js', new Date());
      gtag('config', "<%= process.env.GA_MEASUREMENT_ID %>", {
        send_page_view: false,
        allow_google_signals: false
      });
    };
  }

  window.updateAnalyticsConsent = function(granted) {
    gtag('consent', 'update', {
      analytics_storage: granted ? 'granted' : 'denied'
    });
    if (granted) loadGA();
  };

  window.loadClarity = function() {
    var id = window.env && window.env.CLARITY_ID;
    if (!id) return;
    if (window.clarity) return;
    if (document.querySelector('script[src*="clarity.ms/tag/"]')) return;

    (function(c, l, a, r, i, t, y) {
      c[a] = c[a] || function() {
        (c[a].q = c[a].q || []).push(arguments)
      };
      t = l.createElement(r);
      t.async = 1;
      t.src = "https://www.clarity.ms/tag/" + id;
      y = l.getElementsByTagName(r)[0];
      y.parentNode.insertBefore(t, y);
    })(window, document, "clarity", "script");

    (function tryConsent() {
      if (typeof window.clarity === 'function') {
        try {
          window.clarity('consent', true);
        } catch (e) {}
      } else setTimeout(tryConsent, 200);
    })();
  };
</script>