 <%
  const safeValue = (value) => value ?? '';
  const isChecked = (value) => (value ? 'checked' : '');
  const pagesList = Array.isArray(pages) ? pages : [];
  const adminQuery = query || {};
  const adminSaved = adminQuery.saved === '1';
  const activeTab = adminQuery.tab || (pagesList[0] ? `page-${pagesList[0].id}` : '');
  const getBlock = (blocks, type) => (Array.isArray(blocks) ? blocks.find((block) => block?.type === type) : null) || {};
  const getHeroCtaLabel = (block) => block?.ctaLabel || block?.cta?.label || '';
  const getHeroCtaHref = (block) => block?.ctaHref || block?.cta?.href || '';
  const getHeroImage = (block) => block?.image || block?.imageUrl || block?.img?.src || '';
  const getCtaTitle = (block) => block?.title || block?.headline || '';
  const getCtaText = (block) => block?.text || block?.subline || '';
  const getCtaButtonLabel = (block) => block?.button?.label || block?.cta?.label || '';
  const getCtaButtonHref = (block) => block?.button?.href || block?.cta?.href || '';
  const getImageTextImage = (block) => block?.img?.src || block?.imageUrl || '';
    const getAltValue = (value, locale) => {
    if (value && typeof value === 'object') {
      return value[locale] || '';
    }
    return value || '';
  };
  const getAltDe = (value) => getAltValue(value, 'de');
  const getAltEn = (value) => getAltValue(value, 'en');
  const getImageTextAlt = (block) => block?.img?.alt || block?.imageAlt || '';
  const getRichText = (block) => block?.html || block?.text || '';
  const formatDateTime = (value) => {
    if (!value) return '';
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return '';
    return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
  };
    const galleryCategoryOptions = [
    { value: 'team', label: 'Team & Alltag' },
    { value: 'work', label: 'Arbeiten vor Ort' },
    { value: 'results', label: 'Ergebnisse & Referenzen' }
  ];
  const galleryCategoryLabel = (value) => {
    const option = galleryCategoryOptions.find((entry) => entry.value === value);
    return option?.label || 'Team & Alltag';
  };
%>
 <section class="admin-shell">
   <aside class="admin-sidebar">
     <div class="admin-sidebar__header">
       <h1>Admin Bereich</h1>
     </div>
     <div class="admin-profile">
       <div class="admin-avatar" aria-hidden="true">
         <span>A</span>
       </div>
       <div class="admin-profile__text">
         <strong><%= adminUser?.firstName || 'Admin' %> <%= adminUser?.lastName || '' %></strong>
         <span>eingeloggt</span>
       </div>
     </div>

     <nav class="admin-nav">
       <button class="admin-nav__item is-active" type="button" data-nav-group="pages">
         Webseiten bearbeiten
         <span class="admin-nav__chevron">‹</span>
       </button>
       <button class="admin-nav__item" type="button" data-nav-group="gallery">
         Admin Gallery
         <span class="admin-nav__chevron">›</span>
       </button>
       <button class="admin-nav__item" type="button" data-nav-group="newsletter">
         Newsletter Anmeldungen
         <span class="admin-nav__chevron">›</span>
       </button>
       <a class="admin-nav__item" href="/"></a>
       Website ansehen
       <span class="admin-nav__chevron">›</span>
       </a>
       <form action="/logout" method="post">
         <button class="admin-nav__item" type="submit">
           Logout
           <span class="admin-nav__chevron">›</span>
         </button>
       </form>
     </nav>
   </aside>

   <section class="admin-content">
     <div class="admin-content__section" data-nav-content="pages">
       <header class="admin-content__header">
         <div>
           <h2>Webseiten bearbeiten</h2>
           <p>Bearbeite Inhalte, Meta-Daten und Navigationseinträge der einzelnen Seiten.</p>
         </div>
         <% if (adminSaved) { %>
         <div class="admin-panel__alert admin-panel__alert--success">Änderungen wurden gespeichert.</div>
         <% } %>
       </header>
       <div class="admin-tabs" data-admin-tabs="pages">
         <% pagesList.forEach((page) => { %>
         <button class="admin-tab <%= activeTab === `page-${page.id}` ? 'is-active' : '' %>" type="button" data-tab="page-<%= page.id %>">
           <%= page.title %>
         </button>
         <% }) %>
       </div>
       <% pagesList.forEach((page) => { %>
       <%
        const blocks = Array.isArray(page.content) ? page.content : [];
        const isHomePage = page.canonical_path === '/' || page.slug === 'de' || page.slug === 'home';
        const isLeistungenPage = ['leistungen', 'leistungen-de', 'leistungen-en'].includes(page.slug)
          || ['/leistungen', '/leistungen-de', '/leistungen-en'].includes(page.canonical_path);
        const heroBlock = getBlock(blocks, 'hero');
        const kostenBlock = getBlock(blocks, 'kosten');
        const kontaktBlock = getBlock(blocks, 'kontaktformular');
        const bereicheBlock = getBlock(blocks, 'bereiche');
        const imageTextBlock = getBlock(blocks, 'imageText');
        const richTextBlock = getBlock(blocks, 'richText');
        const ctaBlock = getBlock(blocks, 'cta');
        const faqBlock = getBlock(blocks, 'faq');
        const faqItems = Array.isArray(faqBlock.items) ? faqBlock.items : [];
        const kostenSteps = Array.isArray(kostenBlock.steps) ? kostenBlock.steps : [];
        const kontaktServices = Array.isArray(kontaktBlock.services) ? kontaktBlock.services : [];
        const bereicheSlides = Array.isArray(bereicheBlock?.slider?.slides) ? bereicheBlock.slider.slides : [];
        const bereichePageOptions = pagesList
          .filter((entry) => entry.canonical_path?.startsWith('/leistungen/') && entry.canonical_path !== '/leistungen');
      %>

       <form class="admin-panel <%= activeTab === `page-${page.id}` ? '' : 'is-hidden' %>" method="post" action="/adminbackend/pages/<%= page.id %>" enctype="multipart/form-data" data-panel="page-<%= page.id %>" data-panel-group="pages"> <input type="hidden" name="page_mode" value="<%= isHomePage ? 'home' : 'page' %>">
         <input type="hidden" name="page_mode" value="<%= isHomePage ? 'home' : (isLeistungenPage ? 'leistungen' : 'page') %>">
         <div class="admin-panel__section">
           <h3 class="admin-panel__title">Seiteneinstellungen</h3>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Titel</label>
               <input type="text" name="title" value="<%= safeValue(page.title) %>" required>
             </div>
             <div class="admin-field">
               <label>Slug</label>
               <input type="text" name="slug" value="<%= safeValue(page.slug) %>" required>
             </div>
             <div class="admin-field">
               <label>Canonical Path</label>
               <input type="text" name="canonical_path" value="<%= safeValue(page.canonical_path) %>">
             </div>
           </div>
           <div class="admin-grid">
             <label>Meta Title</label>
             <input type="text" name="meta_title" value="<%= safeValue(page.meta_title) %>">
           </div>
           <div class="admin-field">
             <label>Meta Description</label>
             <input type="text" name="meta_description" value="<%= safeValue(page.meta_description) %>">
           </div>
         </div>
         <div class="admin-grid">
           <div class="admin-field">
             <label>Navigation Label</label>
             <input type="text" name="nav_label" value="<%= safeValue(page.nav_label) %>">
           </div>
           <div class="admin-field">
             <label>Navigation Order</label>
             <input type="number" name="nav_order" value="<%= safeValue(page.nav_order) %>">
           </div>
           <div class="admin-field">
             <label>Locale</label>
             <input type="text" name="locale" value="<%= safeValue(page.locale) %>">
           </div>
           <div class="admin-field">
             <label>i18n Group</label>
             <input type="text" name="i18n_group" value="<%= safeValue(page.i18n_group) %>">
           </div>
         </div>
         <div class="admin-grid">
           <div class="admin-field admin-field--checkbox">
             <div class="admin-field admin-field--checkbox">
               <label>
                 <input type="checkbox" name="show_in_nav" <%= isChecked(page.show_in_nav) %>>
                 Sichtbar im Menü
               </label>
             </div>
             <div class="admin-field admin-field--checkbox">
               <label>
                 <input type="checkbox" name="display" <%= isChecked(page.display) %>>
                 Seite veröffentlichen
               </label>
             </div>
           </div>
         </div>
         <% if (isHomePage) { %>
         <div class="admin-panel__section">
           <h3 class="admin-panel__title">Startseite: Hero</h3>
           <div class="admin-field admin-field--checkbox">
             <label>
               <input type="checkbox" name="home_hero_enabled" <%= isChecked(heroBlock?.type) %>>
               Hero-Bereich aktiv
             </label>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Headline</label>
               <input type="text" name="home_hero_headline" value="<%= safeValue(heroBlock.headline) %>">
             </div>
             <div class="admin-field">
               <label>Subline</label>
               <input type="text" name="home_hero_subline" value="<%= safeValue(heroBlock.subline) %>">
             </div>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>CTA Label</label>
               <input type="text" name="home_hero_cta_label" value="<%= safeValue(getHeroCtaLabel(heroBlock)) %>">
             </div>
             <div class="admin-field">
               <label>CTA Link</label>
               <input type="text" name="home_hero_cta_href" value="<%= safeValue(getHeroCtaHref(heroBlock)) %>">
             </div>
             <div class="admin-field">
               <label>Hero-Bild</label>
               <div class="admin-media-picker" data-gallery-picker data-gallery-allow="image">
                 <div class="admin-media-picker__controls">
                   <button type="button" class="admin-button" data-upload-trigger>Bild hochladen</button>
                   <button type="button" class="admin-button" data-gallery-open>Aus Galerie wählen</button>
                 </div>
                 <input type="file" name="home_hero_image_upload" accept="image/*" data-upload-input hidden>
                 <input type="hidden" name="home_hero_image_gallery_id" data-gallery-input="image" value="">
                 <input type="hidden" name="home_hero_image_current" value="<%= safeValue(getHeroImage(heroBlock)) %>">
                 <small data-gallery-preview>Keine Datei ausgewählt.</small>
                 <% if (getHeroImage(heroBlock)) { %>
                 <a class="admin-media-picker__preview-link" href="<%= getHeroImage(heroBlock) %>" target="_blank" rel="noopener noreferrer" data-media-preview-url="<%= getHeroImage(heroBlock) %>" data-media-preview-type="image">
                   Aktuelles Bild anzeigen
                 </a>
                 <% } %>
               </div>
             </div>
           </div>
         </div>

         <div class="admin-panel__section">
           <h3 class="admin-panel__title">Startseite: Kosten & Ablauf</h3>
           <div class="admin-field admin-field--checkbox">
             <label>
               <input type="checkbox" name="home_kosten_enabled" <%= isChecked(kostenBlock?.type) %>>
               Kosten-Bereich aktiv
             </label>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Headline</label>
               <input type="text" name="home_kosten_headline" value="<%= safeValue(kostenBlock.headline) %>">
             </div>
             <div class="admin-field">
               <label>Subline</label>
               <input type="text" name="home_kosten_subline" value="<%= safeValue(kostenBlock.subline) %>">
             </div>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Lead Text</label>
               <textarea name="home_kosten_lead" rows="3"><%= safeValue(kostenBlock.leadText) %></textarea>
             </div>
             <div class="admin-field">
               <label>Detail Text</label>
               <textarea name="home_kosten_detail" rows="3"><%= safeValue(kostenBlock.detailText) %></textarea>
             </div>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Primary Button Label</label>
               <input type="text" name="home_kosten_primary_label" value="<%= safeValue(kostenBlock.primaryButton?.label) %>">
             </div>
             <div class="admin-field">
               <label>Primary Button Link</label>
               <input type="text" name="home_kosten_primary_href" value="<%= safeValue(kostenBlock.primaryButton?.href) %>">
             </div>
             <div class="admin-field">
               <label>Secondary Button Label</label>
               <input type="text" name="home_kosten_secondary_label" value="<%= safeValue(kostenBlock.secondaryButton?.label) %>">
             </div>
             <div class="admin-field">
               <label>Secondary Button Link</label>
               <input type="text" name="home_kosten_secondary_href" value="<%= safeValue(kostenBlock.secondaryButton?.href) %>">
             </div>
           </div>
           <div class="admin-grid">
             <% [0, 1, 2].forEach((index) => { %>
             <div class="admin-field">
               <label>Schritt <%= index + 1 %> Titel</label>
               <input type="text" name="home_kosten_step<%= index + 1 %>_title" value="<%= safeValue(kostenSteps[index]?.title) %>">
             </div>
             <div class="admin-field">
               <label>Schritt <%= index + 1 %> Bild</label>
               <div class="admin-media-picker" data-gallery-picker data-gallery-allow="image">
                 <div class="admin-media-picker__controls">
                   <button type="button" class="admin-button" data-upload-trigger>Bild hochladen</button>
                   <button type="button" class="admin-button" data-gallery-open>Aus Galerie wählen</button>
                 </div>
                 <input type="file" name="home_kosten_step<%= index + 1 %>_upload" accept="image/*" data-upload-input hidden>
                 <input type="hidden" name="home_kosten_step<%= index + 1 %>_gallery_id" data-gallery-input="image" value="">
                 <input type="hidden" name="home_kosten_step<%= index + 1 %>_image_current" value="<%= safeValue(kostenSteps[index]?.imageUrl) %>">
                 <input type="hidden" name="home_kosten_step<%= index + 1 %>_alt_current_de" value="<%= safeValue(getAltDe(kostenSteps[index]?.imageAlt)) %>">
                 <input type="hidden" name="home_kosten_step<%= index + 1 %>_alt_current_en" value="<%= safeValue(getAltEn(kostenSteps[index]?.imageAlt)) %>">
                 <div class="admin-grid">
                   <div class="admin-field">
                     <label>Alt-Text Deutsch</label>
                     <input type="text" name="home_kosten_step<%= index + 1 %>_alt_de" data-gallery-alt-input="de" value="<%= safeValue(getAltDe(kostenSteps[index]?.imageAlt)) %>">
                   </div>
                   <div class="admin-field">
                     <label>Alt-Text Englisch</label>
                     <input type="text" name="home_kosten_step<%= index + 1 %>_alt_en" data-gallery-alt-input="en" value="<%= safeValue(getAltEn(kostenSteps[index]?.imageAlt)) %>">
                   </div>
                 </div>
                 <small data-gallery-preview>Keine Datei ausgewählt.</small>
                 <% if (kostenSteps[index]?.imageUrl) { %>
                 <a class="admin-media-picker__preview-link" href="<%= kostenSteps[index].imageUrl %>" target="_blank" rel="noopener noreferrer" data-media-preview-url="<%= kostenSteps[index].imageUrl %>" data-media-preview-type="image">
                   Aktuelles Bild anzeigen
                 </a>
                 <% } %>
               </div>
             </div>
             <% }) %>
           </div>
         </div>

         <div class="admin-panel__section">
           <h3 class="admin-panel__title">Startseite: Image Text</h3>
           <div class="admin-field admin-field--checkbox">
             <label>
               <input type="checkbox" name="home_imagetext_enabled" <%= isChecked(imageTextBlock?.type) %>>
               Image-Text Bereich aktiv
             </label>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Titel</label>
               <input type="text" name="home_imagetext_title" value="<%= safeValue(imageTextBlock.title) %>">
             </div>
             <div class="admin-field">
               <label>Text</label>
               <textarea name="home_imagetext_text" rows="4"><%= safeValue(imageTextBlock.text) %></textarea>
             </div>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Bild</label>
               <div class="admin-media-picker" data-gallery-picker data-gallery-allow="image">
                 <div class="admin-media-picker__controls">
                   <button type="button" class="admin-button" data-upload-trigger>Bild hochladen</button>
                   <button type="button" class="admin-button" data-gallery-open>Aus Galerie wählen</button>
                 </div>
                 <input type="file" name="home_imagetext_upload" accept="image/*" data-upload-input hidden>
                 <input type="hidden" name="home_imagetext_gallery_id" data-gallery-input="image" value="">
                 <input type="hidden" name="home_imagetext_image_current" value="<%= safeValue(getImageTextImage(imageTextBlock)) %>">
                 <input type="hidden" name="home_imagetext_alt_current_de" value="<%= safeValue(getAltDe(getImageTextAlt(imageTextBlock))) %>">
                 <input type="hidden" name="home_imagetext_alt_current_en" value="<%= safeValue(getAltEn(getImageTextAlt(imageTextBlock))) %>">
                 <div class="admin-grid">
                   <div class="admin-field">
                     <label>Alt-Text Deutsch</label>
                     <input type="text" name="home_imagetext_alt_de" data-gallery-alt-input="de" value="<%= safeValue(getAltDe(getImageTextAlt(imageTextBlock))) %>">
                   </div>
                   <div class="admin-field">
                     <label>Alt-Text Englisch</label>
                     <input type="text" name="home_imagetext_alt_en" data-gallery-alt-input="en" value="<%= safeValue(getAltEn(getImageTextAlt(imageTextBlock))) %>">
                   </div>
                 </div>
                 <small data-gallery-preview>Keine Datei ausgewählt.</small>
                 <% if (getImageTextImage(imageTextBlock)) { %>
                 <a class="admin-media-picker__preview-link" href="<%= getImageTextImage(imageTextBlock) %>" target="_blank" rel="noopener noreferrer" data-media-preview-url="<%= getImageTextImage(imageTextBlock) %>" data-media-preview-type="image">
                   Aktuelles Bild anzeigen
                 </a>
                 <% } %>
               </div>
             </div>
           </div>
         </div>
         <div class="admin-panel__section">
           <h3 class="admin-panel__title">Startseite: Rich Text</h3>
           <div class="admin-field admin-field--checkbox">
             <label>
               <input type="checkbox" name="home_richtext_enabled" <%= isChecked(richTextBlock?.type) %>>
               Rich-Text Bereich aktiv
             </label>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Titel</label>
               <input type="text" name="home_richtext_title" value="<%= safeValue(richTextBlock.title) %>">
             </div>
           </div>
           <div class="admin-field">
             <label>HTML Inhalt</label>
             <textarea name="home_richtext_html" rows="6"><%= safeValue(getRichText(richTextBlock)) %></textarea>
           </div>
         </div>
         <div class="admin-panel__section">
           <h3 class="admin-panel__title">Startseite: CTA</h3>
           <div class="admin-field admin-field--checkbox">
             <label>
               <input type="checkbox" name="home_cta_enabled" <%= isChecked(ctaBlock?.type) %>>
               CTA-Bereich aktiv
             </label>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Headline</label>
               <input type="text" name="home_cta_title" value="<%= safeValue(getCtaTitle(ctaBlock)) %>">
             </div>
             <div class="admin-field">
               <label>Text</label>
               <textarea name="home_cta_text" rows="3"><%= safeValue(getCtaText(ctaBlock)) %></textarea>
             </div>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Button Label</label>
               <input type="text" name="home_cta_button_label" value="<%= safeValue(getCtaButtonLabel(ctaBlock)) %>">
             </div>
             <div class="admin-field">
               <label>Button Link</label>
               <input type="text" name="home_cta_button_href" value="<%= safeValue(getCtaButtonHref(ctaBlock)) %>">
             </div>
           </div>
         </div>
         <div class="admin-panel__section">
           <h3 class="admin-panel__title">Startseite: FAQ</h3>
           <div class="admin-field admin-field--checkbox">
             <label>
               <input type="checkbox" name="home_faq_enabled" <%= isChecked(faqBlock?.type) %>>
               FAQ-Bereich aktiv
             </label>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>FAQ Titel</label>
               <input type="text" name="home_faq_title" value="<%= safeValue(faqBlock.title) %>">
             </div>
           </div>
           <% [0, 1, 2, 3].forEach((index) => { %>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Frage <%= index + 1 %></label>
               <input type="text" name="home_faq_q<%= index + 1 %>" value="<%= safeValue(faqItems[index]?.q) %>">
             </div>
             <div class="admin-field">
               <label>Antwort <%= index + 1 %></label>
               <textarea name="home_faq_a<%= index + 1 %>" rows="3"><%= safeValue(faqItems[index]?.a) %></textarea>
             </div>
           </div>
           <% }) %>
         </div>
         <% } else if (isLeistungenPage) { %>
         <div class="admin-panel__section">
           <h3 class="admin-panel__title">Leistungen: Hero</h3>
           <div class="admin-field admin-field--checkbox">
             <label>
               <input type="checkbox" name="leistungen_hero_enabled" <%= isChecked(heroBlock?.type) %>>
               Hero-Bereich aktiv
             </label>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Headline</label>
               <input type="text" name="leistungen_hero_headline" value="<%= safeValue(heroBlock.headline) %>">
             </div>
             <div class="admin-field">
               <label>Subline</label>
               <input type="text" name="leistungen_hero_subline" value="<%= safeValue(heroBlock.subline) %>">
             </div>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>CTA Label</label>
               <input type="text" name="leistungen_hero_cta_label" value="<%= safeValue(getHeroCtaLabel(heroBlock)) %>">
             </div>
             <div class="admin-field">
               <label>CTA Link</label>
               <input type="text" name="leistungen_hero_cta_href" value="<%= safeValue(getHeroCtaHref(heroBlock)) %>">
             </div>
             <div class="admin-field">
               <label>Bild-URL</label>
               <input type="text" name="leistungen_hero_image" value="<%= safeValue(getHeroImage(heroBlock)) %>">
             </div>
           </div>
         </div>

         <div class="admin-panel__section">
           <h3 class="admin-panel__title">Leistungen: Kosten & Ablauf</h3>
           <div class="admin-field admin-field--checkbox">
             <label>
               <input type="checkbox" name="leistungen_kosten_enabled" <%= isChecked(kostenBlock?.type) %>>
               Kosten-Bereich aktiv
             </label>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Headline</label>
               <input type="text" name="leistungen_kosten_headline" value="<%= safeValue(kostenBlock.headline) %>">
             </div>
             <div class="admin-field">
               <label>Beschreibung</label>
               <textarea name="leistungen_kosten_description" rows="3"><%= safeValue(kostenBlock.description) %></textarea>
             </div>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>H3 Überschrift</label>
               <input type="text" name="leistungen_kosten_subheading" value="<%= safeValue(kostenBlock.subheading) %>">
             </div>
             <div class="admin-field">
               <label>Subline</label>
               <input type="text" name="leistungen_kosten_subline" value="<%= safeValue(kostenBlock.subline) %>">
             </div>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Lead Text</label>
               <textarea name="leistungen_kosten_lead" rows="3"><%= safeValue(kostenBlock.leadText) %></textarea>
             </div>
             <div class="admin-field">
               <label>Detail Text</label>
               <textarea name="leistungen_kosten_detail" rows="3"><%= safeValue(kostenBlock.detailText) %></textarea>
             </div>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Primary Button Label</label>
               <input type="text" name="leistungen_kosten_primary_label" value="<%= safeValue(kostenBlock.primaryButton?.label) %>">
             </div>
             <div class="admin-field">
               <label>Primary Button Link</label>
               <input type="text" name="leistungen_kosten_primary_href" value="<%= safeValue(kostenBlock.primaryButton?.href) %>">
             </div>
             <div class="admin-field">
               <label>Secondary Button Label</label>
               <input type="text" name="leistungen_kosten_secondary_label" value="<%= safeValue(kostenBlock.secondaryButton?.label) %>">
             </div>
             <div class="admin-field">
               <label>Secondary Button Link</label>
               <input type="text" name="leistungen_kosten_secondary_href" value="<%= safeValue(kostenBlock.secondaryButton?.href) %>">
             </div>
           </div>
           <div class="admin-grid">
             <% [0, 1, 2].forEach((index) => { %>
             <div class="admin-field">
               <label>Schritt <%= index + 1 %> Titel</label>
               <input type="text" name="leistungen_kosten_step<%= index + 1 %>_title" value="<%= safeValue(kostenSteps[index]?.title) %>">
             </div>
             <div class="admin-field">
               <label>Schritt <%= index + 1 %> Bild</label>
               <input type="text" name="leistungen_kosten_step<%= index + 1 %>_image" value="<%= safeValue(kostenSteps[index]?.imageUrl) %>">
             </div>
             <div class="admin-field">
               <label>Schritt <%= index + 1 %> Alt-Text</label>
               <input type="text" name="leistungen_kosten_step<%= index + 1 %>_alt" value="<%= safeValue(kostenSteps[index]?.imageAlt) %>">
             </div>
             <% }) %>
           </div>
         </div>

         <div class="admin-panel__section">
           <h3 class="admin-panel__title">Leistungen: Kontakt & Leistungen</h3>
           <div class="admin-field admin-field--checkbox">
             <label>
               <input type="checkbox" name="leistungen_kontakt_enabled" <%= isChecked(kontaktBlock?.type) %>>
               Kontakt-Bereich aktiv
             </label>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Formular Action</label>
               <input type="text" name="leistungen_kontakt_action" value="<%= safeValue(kontaktBlock.action) %>">
             </div>
             <div class="admin-field">
               <label>Überschrift rechts</label>
               <input type="text" name="leistungen_kontakt_side_title" value="<%= safeValue(kontaktBlock.sideTitle) %>">
             </div>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Beschreibung rechts</label>
               <textarea name="leistungen_kontakt_side_description" rows="3"><%= safeValue(kontaktBlock.sideDescription) %></textarea>
             </div>
             <div class="admin-field">
               <label>H3 Überschrift rechts</label>
               <input type="text" name="leistungen_kontakt_side_subheading" value="<%= safeValue(kontaktBlock.sideSubheading) %>">
             </div>
           </div>
           <div class="admin-field" data-dynamic-list data-max="8">
             <label>Leistung</label>
             <div class="admin-dynamic-list" data-dynamic-list-items>
               <% (kontaktServices.length ? kontaktServices : ['']).forEach((service) => { %>
               <input type="text" name="leistungen_services" value="<%= safeValue(service?.label || service) %>" data-dynamic-list-input>
               <% }) %>
             </div>
           </div>
         </div>

         <div class="admin-panel__section">
           <h3 class="admin-panel__title">Leistungen: Bereiche</h3>
           <div class="admin-field admin-field--checkbox">
             <label>
               <input type="checkbox" name="leistungen_bereiche_enabled" <%= isChecked(bereicheBlock?.type) %>>
               Bereiche-Bereich aktiv
             </label>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Headline</label>
               <input type="text" name="leistungen_bereiche_title" value="<%= safeValue(bereicheBlock.title) %>">
             </div>
             <div class="admin-field">
               <label>Beschreibung</label>
               <textarea name="leistungen_bereiche_description" rows="3"><%= safeValue(bereicheBlock.description) %></textarea>
             </div>
           </div>
           <% [0, 1, 2, 3].forEach((index) => { %>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Slide <%= index + 1 %> Titel</label>
               <input type="text" name="leistungen_bereiche_slide<%= index + 1 %>_title" value="<%= safeValue(bereicheSlides[index]?.title) %>">
             </div>
             <div class="admin-field">
               <label>Slide <%= index + 1 %> Bild</label>
               <input type="text" name="leistungen_bereiche_slide<%= index + 1 %>_image" value="<%= safeValue(bereicheSlides[index]?.image?.src) %>">
             </div>
             <div class="admin-field">
               <label>Slide <%= index + 1 %> Zielseite</label>
               <select name="leistungen_bereiche_slide<%= index + 1 %>_link">
                 <option value="">Bitte wählen</option>
                 <% bereichePageOptions.forEach((entry) => { %>
                 <option value="<%= entry.canonical_path %>" <%= bereicheSlides[index]?.link === entry.canonical_path ? 'selected' : '' %>>
                   <%= entry.title %>
                 </option>
                 <% }) %>
               </select>
             </div>
           </div>
           <% }) %>
         </div>

         <div class="admin-panel__section">
           <h3 class="admin-panel__title">Leistungen: FAQ</h3>
           <div class="admin-field admin-field--checkbox">
             <label>
               <input type="checkbox" name="leistungen_faq_enabled" <%= isChecked(faqBlock?.type) %>>
               FAQ-Bereich aktiv
             </label>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>FAQ Titel</label>
               <input type="text" name="leistungen_faq_title" value="<%= safeValue(faqBlock.title) %>">
             </div>
             <div class="admin-field">
               <label>FAQ Beschreibung</label>
               <textarea name="leistungen_faq_description" rows="3"><%= safeValue(faqBlock.description) %></textarea>
             </div>
           </div>
           <div class="admin-grid">
             <div class="admin-field">
               <label>Button Label</label>
               <input type="text" name="leistungen_faq_button_label" value="<%= safeValue(faqBlock.button?.label) %>">
             </div>
             <div class="admin-field">
               <label>Button Link</label>
               <input type="text" name="leistungen_faq_button_href" value="<%= safeValue(faqBlock.button?.href) %>">
             </div>
           </div>
           <div class="admin-field" data-dynamic-faq data-max="8">
             <label>FAQ Einträge</label>
             <div class="admin-dynamic-faq" data-dynamic-faq-items>
               <% (faqItems.length ? faqItems : [{}]).forEach((item) => { %>
               <div class="admin-dynamic-faq__row" data-dynamic-faq-row>
                 <input type="text" name="leistungen_faq_q" placeholder="Frage" value="<%= safeValue(item?.q) %>" data-dynamic-faq-question>
                 <textarea name="leistungen_faq_a" rows="2" placeholder="Antwort" data-dynamic-faq-answer><%= safeValue(item?.a) %></textarea>
               </div>
               <% }) %>
             </div>
           </div>
         </div>
         <% } else { %>
         <div class="admin-panel__section">
           <h3 class="admin-panel__title">Seiteninhalt (JSON)</h3>
           <p class="admin-panel__hint">Hier kannst du die Komponenten-Blöcke als JSON anpassen.</p>
           <textarea name="content_json" rows="14"><%= safeValue(JSON.stringify(blocks, null, 2)) %></textarea>
         </div>
         <% } %>
         <div class="admin-panel__actions">
           <button type="submit" class="admin-button">Änderungen speichern ✓</button>
         </div>
       </form>
       <% }) %>
     </div>

     <div class="admin-content__section is-hidden" data-nav-content="gallery">
       <header class="admin-content__header">
         <div>
           <h2>Admin Gallery</h2>
           <p>Verwalte Bilder und Videos für die Sauber Mehr Galerie.</p>
         </div>
       </header>
       <div class="admin-tabs admin-tabs--sub" data-gallery-tabs>
         <button class="admin-tab is-active" type="button" data-gallery-tab="images">Bilder</button>
         <button class="admin-tab" type="button" data-gallery-tab="videos">Videos</button>
       </div>
       <section class="admin-panel" data-panel="gallery" data-panel-group="gallery">
         <div class="admin-panel__section">
           <form class="admin-panel__actions admin-panel__actions--inline" id="admin-gallery-visibility-form" method="post" action="/adminbackend/gallery/visibility">
             <button type="submit" class="admin-button">Änderungen speichern</button>
           </form>
         </div>

         <div class="admin-gallery-panel" data-gallery-panel="images">
           <div class="admin-panel__section">
             <h3 class="admin-panel__title">Neues Bild hochladen</h3>
             <form class="admin-gallery-form" method="post" action="/adminbackend/gallery/images" enctype="multipart/form-data">
               <div class="admin-grid">
                 <div class="admin-field">
                   <label>Bilddatei:</label>
                   <input type="file" name="gallery_image_file" accept="image/*" required>
                 </div>
                 <div class="admin-field">
                   <label>Alt-Text Deutsch:</label>
                   <input type="text" name="gallery_image_alt_de" placeholder="Alt-Text Deutsch" required>
                 </div>
                 <div class="admin-field">
                   <label>Alt-Text Englisch:</label>
                   <input type="text" name="gallery_image_alt_en" placeholder="Alt-Text Englisch" required>
                 </div>
               </div>
               <div class="admin-grid">
                 <div class="admin-field">
                   <label>Kategorie</label>
                   <select name="gallery_image_category">
                     <% galleryCategoryOptions.forEach((option) => { %>
                     <option value="<%= option.value %>"><%= option.label %></option>
                     <% }) %>
                   </select>
                 </div>
               </div>
               <div class="admin-panel__actions">
                 <button type="submit" class="admin-button">Bild hochladen ✓</button>
               </div>
             </form>
           </div>

           <div class="admin-panel__section">
             <h3 class="admin-panel__title">Alle Bilder</h3>
             <form class="admin-panel__actions admin-panel__actions--inline" method="post" action="/adminbackend/gallery/images/sort" data-gallery-sort-form>
               <input type="hidden" name="order" value="[]" data-gallery-sort-input>
               <button type="submit" class="admin-button">Sortierung speichern</button>
             </form>
             <% if (galleryImages?.length) { %>
             <div class="admin-gallery-grid" data-gallery-sortable>
               <% galleryImages.forEach((image) => { %>
               <div class="admin-gallery-card" draggable="true" data-gallery-sort-item data-gallery-id="<%= image.id %>" data-gallery-visible="<%= image.show_in_gallery ? 'true' : 'false' %>">
                 <button class="admin-gallery-card__handle" type="button" aria-label="Bild sortieren" data-gallery-drag-handle>↕</button>
                 <div class="admin-gallery-visibility">
                   <input type="hidden" name="images[id_<%= image.id %>]" value="0" form="admin-gallery-visibility-form">
                   <label>
                     <input type="checkbox" name="images[id_<%= image.id %>]" value="1" form="admin-gallery-visibility-form" data-gallery-visibility <%= image.show_in_gallery ? 'checked' : '' %>>
                     <span>showInGallery</span>
                   </label>
                 </div>
                 <div class="admin-field admin-field-gallery-category">
                   <label for="image-category-<%= image.id %>">Kategorie</label>
                   <select id="image-category-<%= image.id %>" name="image_categories[id_<%= image.id %>]" form="admin-gallery-visibility-form">
                     <% galleryCategoryOptions.forEach((option) => { %>
                     <option value="<%= option.value %>" <%= image.gallery_category === option.value ? 'selected' : '' %>><%= option.label %></option>
                     <% }) %>
                   </select>
                 </div>
                 <form class="admin-gallery-delete" method="post" action="/adminbackend/gallery/images/<%= image.id %>/delete">
                   <button type="submit" aria-label="Bild löschen">×</button>
                 </form>
                 <img src="<%= image.cloudinary_url || image.local_path %>" alt="<%= image.alt_de || '' %>">
                 <div class="admin-gallery-meta">
                   <p><strong>Datei:</strong> <%= image.original_name || image.filename %></p>
                   <p><strong>Größe:</strong> <%= image.size_bytes || '-' %> Bytes</p>
                   <p><strong>Alt (DE):</strong> <%= image.alt_de || '-' %></p>
                   <p><strong>Kategorie:</strong> <%= galleryCategoryLabel(image.gallery_category) %></p>
                 </div>
               </div>
               <% }) %>
             </div>
             <% } else { %>
             <p class="admin-empty">Keine Bilder vorhanden.</p>
             <% } %>
           </div>
         </div>

         <div class="admin-gallery-panel is-hidden" data-gallery-panel="videos">
           <div class="admin-panel__section">
             <h3 class="admin-panel__title">Neues Video hochladen</h3>
             <form class="admin-gallery-form" method="post" action="/adminbackend/gallery/videos" enctype="multipart/form-data">
               <div class="admin-grid">
                 <div class="admin-field">
                   <label>Videodatei:</label>
                   <input type="file" name="gallery_video_file" accept="video/*" required>
                 </div>
                 <div class="admin-field">
                   <label>Alt-Text Deutsch:</label>
                   <input type="text" name="gallery_video_alt_de" placeholder="Alt-Text Deutsch" required>
                 </div>
                 <div class="admin-field">
                   <label>Alt-Text Englisch:</label>
                   <input type="text" name="gallery_video_alt_en" placeholder="Alt-Text Englisch" required>
                 </div>
               </div>
               <div class="admin-grid">
                 <div class="admin-field">
                   <label>Kategorie</label>
                   <select name="gallery_video_category">
                     <% galleryCategoryOptions.forEach((option) => { %>
                     <option value="<%= option.value %>"><%= option.label %></option>
                     <% }) %>
                   </select>
                 </div>
               </div>
               <div class="admin-panel__actions">
                 <button type="submit" class="admin-button">Video hochladen ✓</button>
               </div>
             </form>
           </div>
           <div class="admin-panel__section">
             <h3 class="admin-panel__title">Alle Videos</h3>
             <form class="admin-panel__actions admin-panel__actions--inline" method="post" action="/adminbackend/gallery/videos/sort" data-gallery-sort-form>
               <input type="hidden" name="order" value="[]" data-gallery-sort-input>
               <button type="submit" class="admin-button">Sortierung speichern</button>
             </form>
             <% if (galleryVideos?.length) { %>
             <div class="admin-gallery-grid" data-gallery-sortable>
               <% galleryVideos.forEach((video) => { %>
               <div class="admin-gallery-card" draggable="true" data-gallery-sort-item data-gallery-id="<%= video.id %>" data-gallery-visible="<%= video.show_in_gallery ? 'true' : 'false' %>">
                 <button class="admin-gallery-card__handle" type="button" aria-label="Video sortieren" data-gallery-drag-handle>↕</button>
                 <div class="admin-gallery-visibility">
                   <input type="hidden" name="videos[id_<%= video.id %>]" value="0" form="admin-gallery-visibility-form">
                   <label>
                     <input type="checkbox" name="videos[id_<%= video.id %>]" value="1" form="admin-gallery-visibility-form" data-gallery-visibility <%= video.show_in_gallery ? 'checked' : '' %>>
                     <span>showInGallery</span>
                   </label>
                 </div>
                 <div class="admin-field admin-field-gallery-category">
                   <label for="video-category-<%= video.id %>">Kategorie</label>
                   <select id="video-category-<%= video.id %>" name="video_categories[id_<%= video.id %>]" form="admin-gallery-visibility-form">
                     <% galleryCategoryOptions.forEach((option) => { %>
                     <option value="<%= option.value %>" <%= video.gallery_category === option.value ? 'selected' : '' %>><%= option.label %></option>
                     <% }) %>
                   </select>
                 </div>
                 <form class="admin-gallery-delete" method="post" action="/adminbackend/gallery/videos/<%= video.id %>/delete">
                   <button type="submit" aria-label="Video löschen">×</button>
                 </form>
                 <video src="<%= video.cloudinary_url || video.local_path %>" controls></video>
                 <div class="admin-gallery-meta">
                   <p><strong>Datei:</strong> <%= video.original_name || video.filename %></p>
                   <p><strong>Größe:</strong> <%= video.size_bytes || '-' %> Bytes</p>
                   <p><strong>Alt (DE):</strong> <%= video.alt_de || '-' %></p>
                   <p><strong>Kategorie:</strong> <%= galleryCategoryLabel(video.gallery_category) %></p>
                 </div>
               </div>
               <% }) %>
             </div>
             <% } else { %>
             <p class="admin-empty">Keine Videos vorhanden.</p>
             <% } %>
           </div>
         </div>
       </section>
     </div>
     <div class="admin-content__section is-hidden" data-nav-content="newsletter">
       <header class="admin-content__header">
         <div>
           <h2>Newsletter Anmeldungen</h2>
           <p>Übersicht aller Newsletter-Anmeldungen für Sauber Mehr.</p>
         </div>
       </header>
       <section class="admin-panel">
         <div class="admin-panel__section">
           <% if (!newsletterSubscriptions || newsletterSubscriptions.length === 0) { %>
           <p class="admin-empty">Noch keine Anmeldungen vorhanden.</p>
           <% } else { %>
           <div class="admin-newsletter-table__wrapper">
             <table class="admin-newsletter-table">
               <thead>
                 <tr>
                   <th>Email</th>
                   <th>Artikel-News</th>
                   <th>Video-News</th>
                   <th>Sprache</th>
                   <th>Datum</th>
                 </tr>
               </thead>
               <tbody>
                 <% newsletterSubscriptions.forEach((entry) => { %>
                 <tr>
                   <td><%= entry.email %></td>
                   <td><%= entry.newsletter_articles ? 'ja' : 'nein' %></td>
                   <td><%= entry.newsletter_videos ? 'ja' : 'nein' %></td>
                   <td><%= entry.newsletter_language || '-' %></td>
                   <td><%= formatDateTime(entry.created_at) %></td>
                 </tr>
                 <% }) %>
               </tbody>
             </table>
           </div>
           <% } %>
         </div>
       </section>
     </div>

     <div class="admin-gallery-selector is-hidden" data-gallery-selector>
       <div class="admin-gallery-selector__backdrop" data-gallery-close></div>
       <div class="admin-gallery-selector__modal">
         <div class="admin-gallery-selector__header">
           <h3>Medien auswählen</h3>
           <button type="button" class="admin-gallery-selector__close" data-gallery-close>×</button>
         </div>
         <div class="admin-gallery-selector__tabs">
           <button type="button" class="admin-tab is-active" data-gallery-selector-tab="images">Bilder</button>
           <button type="button" class="admin-tab" data-gallery-selector-tab="videos">Videos</button>
         </div>
         <div class="admin-gallery-selector__panel" data-gallery-selector-panel="images">
           <div class="admin-gallery-selector__grid">
             <% (galleryImages || []).forEach((image) => { %>
             <button type="button" class="admin-gallery-selector__item" data-gallery-item data-gallery-item-type="image" data-gallery-item-id="<%= image.id %>" data-gallery-item-url="<%= image.cloudinary_url || image.local_path %>" data-gallery-item-label="<%= image.original_name || image.filename %>" data-gallery-item-alt-de="<%= image.alt_de || '' %>" data-gallery-item-alt-en="<%= image.alt_en || '' %>">
               <img src="<%= image.cloudinary_url || image.local_path %>" alt="<%= image.alt_de || '' %>">
               <span><%= image.original_name || image.filename %></span>
             </button>
             <% }) %>
           </div>
         </div>
         <div class="admin-gallery-selector__panel is-hidden" data-gallery-selector-panel="videos">
           <div class="admin-gallery-selector__grid">
             <% (galleryVideos || []).forEach((video) => { %>
             <button type="button" class="admin-gallery-selector__item" data-gallery-item data-gallery-item-type="video" data-gallery-item-id="<%= video.id %>" data-gallery-item-url="<%= video.cloudinary_url || video.local_path %>" data-gallery-item-label="<%= video.original_name || video.filename %>">
               <video src="<%= video.cloudinary_url || video.local_path %>" muted></video>
               <span><%= video.original_name || video.filename %></span>
             </button>
             <% }) %>
           </div>
         </div>
       </div>
     </div>
   </section>
 </section>