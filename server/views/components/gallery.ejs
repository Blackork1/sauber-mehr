<% const galleryImageList = Array.isArray(galleryImages) ? galleryImages : []; %>
<% const galleryVideoList = Array.isArray(galleryVideos) ? galleryVideos : []; %>
<% const locale = String(page?.locale || '').toLowerCase(); %>
<% const localeKey = locale.startsWith('en') ? 'en' : (locale.startsWith('ku') ? 'ku' : 'de'); %>
<% const altKey = locale.startsWith('en') ? 'alt_en' : (locale.startsWith('ku') ? 'alt_ku' : 'alt_de'); %>
<% const emptyMessage = locale.startsWith('en')
  ? 'There are currently no media items enabled for the gallery.'
  : (locale.startsWith('ku')
    ? 'Niha ji bo galeriyê ti medyayê nehatine berdan.'
    : 'Aktuell sind noch keine Medien für die Gallery freigeschaltet.'); %>
<% const hasMedia = galleryImageList.length + galleryVideoList.length; %>
<% const galleryCategories = [
  { key: 'films', labels: { de: 'Filme', en: 'Movies', ku: 'Fîlm' } },
  { key: 'events', labels: { de: 'Veranstaltungen', en: 'Events', ku: 'Çalakî' } },
  { key: 'moments', labels: { de: 'Momente vom Festival', en: 'Festival Moments', ku: 'Demên Festîvalê' } }
]; %>
<% const mediaByCategory = galleryCategories.reduce((acc, category) => {
  acc[category.key] = [];
  return acc;
}, {}); %>
<% galleryImageList.forEach((image) => {
  const category = image.gallery_category || 'moments';
  if (mediaByCategory[category]) {
    mediaByCategory[category].push({ ...image, type: 'image' });
  }
}); %>
<% galleryVideoList.forEach((video) => {
  const category = video.gallery_category || 'moments';
  if (mediaByCategory[category]) {
    mediaByCategory[category].push({ ...video, type: 'video' });
  }
}); %>
<% if (hasMedia) { %>
  <% galleryCategories.forEach((category) => { %>
    <section class="festival-gallery__section">
      <h3 class="festival-gallery__heading"><%= category.labels[localeKey] %></h3>
      <% const categoryItems = mediaByCategory[category.key]; %>
      <% if (categoryItems.length) { %>
        <div class="festival-gallery__grid">
          <% categoryItems.forEach((item) => { %>
            <figure class="festival-gallery__item">
              <% if (item.type === 'image') { %>
                <img src="<%= item.cloudinary_url || item.local_path %>" alt="<%= item[altKey] || '' %>" loading="lazy">
              <% } else { %>
                <video controls preload="metadata" aria-label="<%= item[altKey] || '' %>">
                  <source src="<%= item.cloudinary_url || item.local_path %>">
                </video>
              <% } %>
            </figure>
          <% }) %>
        </div>
      <% } %>
    </section>
  <% }) %>
<% } else { %>
  <p class="festival-gallery__empty"><%= emptyMessage %></p>
<% } %>