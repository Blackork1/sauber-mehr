<%
  const action = block?.action || '/contact';
  const layout = block?.layout || 'default';
  const badge = block?.badge || 'Kontakt';
  const headline = block?.headline || 'Kontaktiere uns noch';
  const headlineAccent = block?.headlineAccent || 'Heute';
  const intro = block?.intro || 'Du suchst eine zuverlässige B2B-Reinigung, die mit einem kleinen, eingespielten Team fast alle Leistungen aus einer Hand abdeckt? Dann lass uns kurz sprechen.';
  const details = block?.details || 'In einem 10-Minuten-Call klären wir Objekt, Turnus und Sonderwünsche – danach erhältst du ein transparentes, unverbindliches Angebot.';
  const sideTitle = block?.sideTitle || 'Professionelle Reinigung in Berlin';
  const sideDescription = block?.sideDescription || 'Wir melden uns innerhalb von 24 Stunden bei dir. Dein Angebot wird kostenlos und auf deine Bedürfnisse angepasst erstellt.';
  const sideSubheading = block?.sideSubheading || 'folgende Leistungen bieten wir an';
  const services = Array.isArray(block?.services) ? block.services : [];
  const normalizedServices = services
    .map((service) => {
      if (!service) return null;
      if (typeof service === 'string') {
        return { label: service, href: '' };
      }
      return {
        label: service.label || service.title || '',
        href: service.href || service.link || ''
      };
    })
    .filter((service) => service?.label);
  const isHomePage = page?.canonical_path === '/' || page?.slug === 'de' || page?.slug === 'home';
  const isLeistungenOverviewPage =
    page?.canonical_path === '/leistungen'
    || page?.canonical_path === '/leistungen-de'
    || page?.canonical_path === '/leistungen-en'
    || ['leistungen', 'leistungen-de', 'leistungen-en'].includes(page?.slug);
  const dynamicServices = (Array.isArray(servicePages) ? servicePages : [])
    .map((servicePage) => {
      const label = String(servicePage?.title || '').trim();
      if (!label) return null;
      return {
        label,
        href: servicePage?.canonical_path || ''
      };
    })
    .filter((service) => service?.label);
  const withOtherService = [...dynamicServices, { label: 'Sonstige Reinigung', href: '' }];
  const dedupeServices = (items) => {
    const seen = new Set();
    return items.filter((item) => {
      const key = String(item?.label || '').trim().toLowerCase();
      if (!key || seen.has(key)) return false;
      seen.add(key);
      return true;
    });
  };
  const startPageServices = dedupeServices(withOtherService);
  const selectServices = (isHomePage || isLeistungenOverviewPage) ? startPageServices : normalizedServices;
  const contactItems = block?.contactItems || [];
  const resolveContactHref = (item) => {
    const explicitHref = String(item?.href || item?.link || '').trim();
    if (explicitHref) return explicitHref;
    const text = String(item?.text || '').trim();
    if (!text) return '';
    const emailMatch = text.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
    if (emailMatch) return `mailto:${emailMatch[0]}`;
    const normalizedPhone = text.replace(/[^+\d]/g, '');
    if (normalizedPhone.length >= 7) {
      const telValue = normalizedPhone.startsWith('+') ? normalizedPhone : `+${normalizedPhone}`;
      return `tel:${telValue}`;
    }
    return '';
  };
    const isLeistungenSubpage =
      page?.canonical_path?.startsWith('/leistungen/')
    && page?.canonical_path !== '/leistungen';
  const autoServiceName = block?.serviceName || page?.title || '';
  const shouldAutoService = layout === 'services' && isLeistungenSubpage && autoServiceName;
%>

<section class="sauber-kontakt section" id="kontakt">
  <div class="section__inner sauber-kontakt__inner <%= layout === 'services' ? 'sauber-kontakt__inner--services' : '' %>">
    <% if (layout !== 'services') { %>
    <div class="sauber-kontakt__content">
      <div class="sauber-kontakt__badge animate-on-scroll">
        <span class="sauber-kontakt__badge-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" role="img" focusable="false">
            <path d="M4 6h16v12H4z" fill="none" stroke="currentColor" stroke-width="2" />
            <path d="m4 7 8 6 8-6" fill="none" stroke="currentColor" stroke-width="2" />
          </svg>
        </span>
        <span><%= badge %></span>
      </div>
      <h2 class="sauber-kontakt__headline animate-on-scroll">
        <span><%= headline %></span>
        <span class="sauber-kontakt__headline-accent"><%= headlineAccent %></span>
      </h2>
      <p class="sauber-kontakt__intro animate-on-scroll"><%= intro %></p>
      <p class="sauber-kontakt__intro animate-on-scroll"><%= details %></p>

      <div class="sauber-kontakt__items">
        <% contactItems.forEach(item => { %>
        <div class="sauber-kontakt__item animate-on-scroll">
          <span class="sauber-kontakt__item-icon" aria-hidden="true">
            <%- item.icon %>
          </span>
          <% const contactHref = resolveContactHref(item); %>
          <% if (contactHref) { %>
          <a class="sauber-kontakt__item-text" href="<%= contactHref %>"><%= item.text %></a>
          <% } else { %>
          <span class="sauber-kontakt__item-text"><%= item.text %></span>
          <% } %>
        </div>
        <% }) %>
      </div>
    </div>
    <%} %>

    <div class="sauber-kontakt__card-wrap">
      <form class="sauber-kontakt__card" method="post" action="<%= action %>" enctype="multipart/form-data">
        <label class="sauber-kontakt__field">
          <span>Dein Name</span>
          <input type="text" name="name" placeholder="Name" required>
        </label>
        <label class="sauber-kontakt__field">
          <span>Deine Mail</span>
          <input type="email" name="email" placeholder="Mail" required>
        </label>
        <% if (shouldAutoService) { %>
        <label class="sauber-kontakt__field">
          <span>Leistung</span>
          <input type="text" value="<%= autoServiceName %>" readonly>
          <input type="hidden" name="service" value="<%= autoServiceName %>">
        </label>
        <% } else { %>
        <label class="sauber-kontakt__field">
          <span>Leistung auswählen</span>
          <select name="service" required>
            <option value="" disabled selected>Leistungen</option>
            <% selectServices.forEach(service => { %>
            <option value="<%= service.label %>"><%= service.label %></option>
            <% }) %>
          </select>
        </label>
        <% } %>
        <label class="sauber-kontakt__field">
          <span>Bilder hochladen (optional)</span>
          <input type="file" name="attachments" accept="image/*" multiple>
        </label>
        <button class="sauber-kontakt__button" type="submit">Absenden</button>
      </form>
    </div>

    <% if (layout === 'services') { %>
    <div class="sauber-kontakt__aside">
      <h2 class="sauber-kontakt__aside-title animate-on-scroll"><%- renderTextWithLinks(sideTitle) %></h2>
      <p class="sauber-kontakt__aside-text animate-on-scroll"><%- renderTextWithLinks(sideDescription) %></p>
      <h3 class="sauber-kontakt__aside-subtitle animate-on-scroll"><%- renderTextWithLinks(sideSubheading) %></h3>
      <ul class="sauber-kontakt__service-list">
        <% normalizedServices.forEach(service => { %>
        <li class="sauber-kontakt__service-item animate-on-scroll">
          <span class="sauber-kontakt__service-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="img" focusable="false">
              <path d="M20 6 9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </span>
          <% if (service.href) { %>
          <a href="<%= service.href %>"><%= service.label %></a>
          <% } else { %>
          <span><%= service.label %></span>
          <% } %>
        </li>
        <% }) %>
      </ul>
    </div>
    <% } %>
  </div>
</section>
