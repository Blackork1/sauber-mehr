<%
  const title = block?.title || 'Weitere Leistungen';
  const description = block?.description || '';
  const buttonLabel = block?.buttonLabel || 'Mehr Infos';
  const emptyText = block?.emptyText || 'Aktuell sind keine weiteren Leistungen vorhanden.';
  const servicePagesList = Array.isArray(servicePages) ? servicePages : [];
  const normalizePath = (value) => {
    const pathValue = String(value || '').trim();
    if (!pathValue) return '';
    if (pathValue === '/') return '/';
    return pathValue.replace(/\/+$/, '');
  };
  const currentPath = normalizePath(page?.canonical_path);
  const filteredServicePages = servicePagesList.filter((servicePage) => (
    normalizePath(servicePage?.canonical_path) !== currentPath
  ));
  const cardItems = filteredServicePages.map((servicePage) => {
    const blocks = Array.isArray(servicePage?.content) ? servicePage.content : [];
    const heroBlock = blocks.find((entry) => entry?.type === 'hero') || {};
    const heroGallery = Array.isArray(heroBlock.gallery) ? heroBlock.gallery : [];
    const imageSource = heroGallery[0]?.src || heroBlock.image || '';
    const imageAlt = heroGallery[0]?.alt || heroBlock.imageAlt || servicePage?.title || '';
    const summary = heroBlock.subline || servicePage?.meta_description || '';
    return {
      title: heroBlock.headline || servicePage?.title || '',
      description: summary,
      href: servicePage?.canonical_path || '',
      buttonLabel,
      image: {
        src: imageSource,
        alt: imageAlt
      }
    };
  });
%>

<section class="leistungen-unterseiten section">
  <div class="section__inner leistungen-unterseiten__inner ">
    <div class="leistungen-unterseiten__header">
      <h2 class="leistungen-unterseiten__title animate-on-scroll"><%- renderTextWithLinks(title) %></h2>
      <% if (description) { %>
      <p class="leistungen-unterseiten__text animate-on-scroll"><%- renderTextWithLinks(description) %></p>
      <% } %>
    </div>

    <%- include('./universalSlider', {
      sliderClass: 'leistungen-unterseiten__slider animate-on-scroll',
      sliderItems: cardItems,
      sliderItemPartial: './partials/leistungenCardItem',
      sliderEmptyText: emptyText,
      sliderItemSelector: '[data-slider-item]'
    }) %>
  </div>
</section>
