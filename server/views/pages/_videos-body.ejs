<%
  const video = heroVideo || null;
  const kinoTicketPath = ticketPaths?.kino || '/tickets-de?ticket=kino';
  const onlineTicketPath = ticketPaths?.online || '/tickets-de?ticket=online';
  const showOnlineButton = !hasOnlineTicket;
  const videoEmbed = video?.video_url || '';
  const isEmbedCode = /<\s*(iframe|video|embed|object)/i.test(videoEmbed);
  const isEmbedUrl = /^(https?:)?\/\//i.test(videoEmbed);
  const hasPlayableEmbed = Boolean(videoEmbed && (isEmbedCode || isEmbedUrl));
  const detailView = Boolean(isDetailView);
  const backPath = basePath || page?.canonical_path || '/video';
  const videoScenes = Array.isArray(video?.other_images)
    ? video.other_images.filter((scene) => Boolean(scene))
    : [];%>

<article class="page videos-page">
  <% if (detailView) { %>
  <a class="video-back-link" href="<%= backPath %>">
    <span aria-hidden="true">←</span>
    <span>zu allen Videos</span>
  </a>
  <% } %>
  <section class="section video-hero" data-component="video-hero">
    <div class="section__inner video-hero__inner">
      <% if (!video) { %>
      <div class="video-hero__empty">Aktuell sind keine Videos verfügbar.</div>
      <% } else { %>
      <div class="video-hero__media-stack">
        <div class="video-hero__media" data-video-hero>
          <% if (hasOnlineTicket && hasPlayableEmbed) { %>
          <div class="video-hero__player">
            <% if (isEmbedCode) { %>
            <%- videoEmbed %>
            <% } else { %>
            <iframe src="<%= videoEmbed %>" title="<%= video.title %>" allow="autoplay; fullscreen" allowfullscreen loading="lazy">
            </iframe>
            <% } %>
          </div>
          <button class="video-hero__play" type="button" data-video-play>
            <span>▶</span>
            <span>Abspielen</span>
          </button>
          <% } else { %>
          <div class="video-hero__thumbnail" style="<%= video.thumbnail_url ? `background-image: url('${video.thumbnail_url}');` : '' %>"></div>
          <% } %>
        </div>
        <% if (detailView && videoScenes.length) { %>
        <div class="video-hero__scenes" data-video-scenes>
          <p class="video-hero__scenes-label">Szenen</p>
          <div class="video-hero__scenes-grid" data-video-scenes-grid>
            <% videoScenes.forEach((scene, index) => { %>
            <% const isVideoScene = /\.(mp4|webm|ogg)(\?|#|$)/i.test(scene); %>
            <button class="video-hero__scene" type="button" data-scene-index="<%= index %>" data-scene-src="<%= scene %>" data-scene-type="<%= isVideoScene ? 'video' : 'image' %>">
              <% if (isVideoScene) { %>
              <video src="<%= scene %>" muted playsinline preload="metadata"></video>
              <% } else { %>
              <img src="<%= scene %>" alt="<%= `${video.title || 'Szene'} ${index + 1}` %>">
              <% } %>
            </button>
            <% }) %>
          </div>
          <div class="video-scenes-lightbox" data-video-scenes-lightbox hidden>
            <div class="video-scenes-lightbox__overlay" data-video-scenes-overlay>
              <div class="video-scenes-lightbox__frame" data-video-scenes-frame role="dialog" aria-modal="true" aria-label="Szenen Galerie">
                <button class="video-scenes-lightbox__close" type="button" data-video-scenes-close aria-label="Galerie schließen">×</button>
                <button class="video-scenes-lightbox__arrow video-scenes-lightbox__arrow--left" type="button" data-video-scenes-prev aria-label="Vorherige Szene">
                  <span aria-hidden="true">‹</span>
                </button>
                <div class="video-scenes-lightbox__media" data-video-scenes-media></div>
                <button class="video-scenes-lightbox__arrow video-scenes-lightbox__arrow--right" type="button" data-video-scenes-next aria-label="Nächste Szene">
                  <span aria-hidden="true">›</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        <% } %>
      </div>
      <div class="video-hero__details">
        <h1 class="video-hero__title"><%- renderTextWithLinks(video.title) %></h1>
        <dl class="video-hero__meta">
          <% if (video.published_at) { %>
          <div>
            <dt>Erscheinungsjahr</dt>
            <dd><%= new Date(video.published_at).getFullYear() %></dd>
          </div>
          <% } %>
          <% if (video.languages) { %>
          <div>
            <dt>Verfügbare Sprachen</dt>
            <dd><%- renderTextWithLinks(video.languages) %></dd>
          </div>
          <% } %>
          <% if (video.regie) { %>
          <div>
            <dt>Regie</dt>
            <dd>
              <% if (video.regie_url) { %>
              <a class="video-hero__link" href="<%= video.regie_url %>"><%= video.regie %></a>
              <% } else { %>
              <%- renderTextWithLinks(video.regie) %>
              <% } %>
            </dd>
          </div>
          <% } %>
          <% if (video.production) { %>
          <div>
            <dt>Produktion</dt>
            <dd><%- renderTextWithLinks(video.production) %></dd>
          </div>
          <% } %>
          <% if (video.duration) { %>
          <div>
            <dt>Laufzeit</dt>
            <dd><%- renderTextWithLinks(`${video.duration} min`) %></dd>
          </div>
          <% } %>
        </dl>
        <p class="video-hero__description"><%- renderTextWithLinks(video.description || '') %></p>
        <div class="video-hero__actions">
          <% if (showOnlineButton) { %>
          <a class="video-hero__button video-hero__button--primary" href="<%= onlineTicketPath %>">Onlineticket kaufen</a>
          <% } %>
          <a class="video-hero__button video-hero__button--secondary" href="<%= kinoTicketPath %>">Kinoticket kaufen</a>
        </div>
      </div>
      <% } %>
    </div>
  </section>

  <section class="section video-categories" data-component="video-categories">
    <div class="section__inner video-categories__inner">
      <% (categorySections || []).forEach((section) => { %>
      <div class="video-category" data-video-category>
        <div class="video-category__header">
          <h2><%- renderTextWithLinks(section.category) %></h2>
        </div>
        <div class="video-category__carousel" data-video-carousel>
          <% if (!section.items.length) { %>
          <div class="video-category__empty">Keine Videos in dieser Kategorie.</div>
          <% } %>
          <% section.items.forEach((item) => { %>
          <% const itemScenes = Array.isArray(item.other_images) ? item.other_images.filter((scene) => Boolean(scene)) : []; %>
          <a class="video-card" data-video-card href="<%= `${backPath}/${item.id}` %>" data-video-id="<%= item.id %>" data-video-title="<%= item.title || '' %>" data-video-description="<%= item.description_short || item.description || '' %>" data-video-year="<%= item.published_at ? new Date(item.published_at).getFullYear() : '' %>" data-video-languages="<%= item.languages || '' %>" data-video-regie="<%= item.regie || '' %>" data-video-production="<%= item.production || '' %>" data-video-duration="<%= item.duration ? `${item.duration} min` : '' %>" data-video-thumbnail="<%= item.thumbnail_url || '' %>" data-video-scenes="<%= encodeURIComponent(JSON.stringify(itemScenes)) %>">
            <div class="video-card__thumb" style="<%= item.thumbnail_url ? `background-image: url('${item.thumbnail_url}');` : '' %>"></div>
            <div class="video-card__title"><%= item.title %></div>
          </a>
          <% }) %>
        </div>
        <div class="video-card-preview" data-video-preview hidden>
          <div class="video-card-preview__inner">
            <div class="video-card-preview__media-stack">
              <a class="video-card-preview__media" data-preview-link href="#">
                <div class="video-card-preview__image" data-preview-image></div>
              </a>
              <div class="video-card-preview__scenes" data-preview-scenes hidden>
                <p class="video-card-preview__scenes-label">Szenen</p>
                <div class="video-card-preview__scenes-grid" data-preview-scenes-grid></div>
              </div>
            </div>
            <div class="video-card-preview__content">
              <h3 class="video-card-preview__title" data-preview-title></h3>
              <dl class="video-card-preview__meta" data-preview-meta></dl>
              <p class="video-card-preview__description" data-preview-description></p>
            </div>
          </div>
        </div>
      </div>
      <% }) %>
    </div>
  </section>
</article>